pipeline {
    agent any
    environment {
      github = credentials('github')
      dockerhub = credentials('dockerhub')
    }
     stages {
        stage('build') {
           steps {
               sh '''
                 until docker container ls ; do sleep 3 ;done && docker build -t ${dockerhub_USR}/argocd-demo-web-frontend:web-frontend-${GIT_COMMIT} ./web-frontend/
                 docker login -u ${dockerhub_USR} -p ${dockerhub_PSW} && docker push ${dockerhub_USR}/argocd-demo-web-frontend:web-frontend-${GIT_COMMIT}
                 '''
           }
        }
       stage('deploy') {
           steps {
               sh '''
                     git config --global user.email "gargimehendale@gmail.com"
                     git config --global user.name "Gargi Mehendale"
                     git checkout argocd
                     git pull origin argocd
                     export image_tag="${dockerhub_USR}/argocd-demo-web-frontend:web-frontend-${GIT_COMMIT}" 
                     yq eval '.spec.template.spec.containers[0].image = env(image_tag)' -i ./argo-applications/web-frontend/deployment.yaml
                     git add . 
                     git commit -m "Updated image tag for web-frontend" 
                     git push https://${github_USR}:${github_PSW}@github.com/gargimehendale/argocd-jenkins-forked.git
                  '''
             
           }
       }

     }
}
